# 慢查询优化

## 慢查询的常见原因

redis慢查询的产生可能由外部环境或内部操作引起的。

### 外部原因

- 网络延迟：客户端与redis服务器之间的网络延迟可能导致客户端感知到的响应时间变长

- cpu竞争：redis是单线程的，如果服务器cpu资源被其他进程占用，可能导致redis命令执行变慢

- 内存不足：当redis使用的内存接近服务器的物理内存时，可能会触发内存交换(swap)，导致性能下降

### 内部原因

- 高复杂度的命令

  keys：遍历所有键，时间复杂度为O(N)，可能导致性能瓶颈

  sort：对数据进行排序，时间复杂度为O(NlogN)，当数据量较大时会显著影响性能

  sunion，zunionstore：聚合类命令，当操作的数据量较大时会消耗较多cpu资源

- bigkey操作

  bigkey是存储了大量数据的key(如大list set或hash)。对bigkey的操作(del set)可能会导致redis阻塞，因为这些操作需要处理大量数据

## 慢查询日志

随着业务规模的扩大和数据量的增加，redis性能问题逐渐显现，其中慢查询是一个常见的性能瓶颈。

redis的慢查询日志是诊断性能问题的重要工具，它记录了执行时间超过预设阈值的命令，每条日志包含如下关键信息：

- 标识ID：唯一标识每条慢查询日志

- 发生之间戳：命令执行时间

- 命令耗时：命令的执行时间(单位为微秒)

- 执行命令和参数：记录执行的命令和参数

慢查询日志的配置参数如下(redis.conf)

```
slowlog-log-slower-than  10000  # 默认 10ms，建议设置为1ms

slowlog-max-len          128    # 最多存储 128 条慢查询数据
```
- slowlog-log-slower-than：设置命令执行时间的阈值(单位为微秒)。默认为10000微秒(10毫秒)。如果设置为0，则记录所有命令，如果设置为负值，则不记录任何命令

- slowlog-max-len：设置慢查询日志的最大长度，当日志达到最大长度时，最早的日志会被移除

在生成环境中，建议将slowlog-log-slower-than设置为1毫秒(1000微秒)，以便更早地发现潜在的性能问题。同时，根据实际需求调整slowlog-max-log，以存储更多慢查询日志。

借助于第三方工具Promethus和Grafana，可以实现更全面的性能监控

## 慢查询优化策略

- 优化命令使用：避免使用 keys sort等命令，改用scan在客户端完成数据聚合

- 分页处理大数据集：对于需要处理大量数据的操作，使用分页命令(如 lrange)逐步获取数据

- 使用批量操作：对于多个操作，使用 mget，mset 等批量命令减少网络耗时

- 优化bigkey操作，对于大对象，可以将其拆分成多个小对象，减少单次操作开销。避免一次性删除bigkey阻塞redis服务

- 调整日志参数：根据实际需求调整slowlog-log-slower-than和slowlog-max-len参数，及早发现问题

- 优化内存管理：合理设置maxmemory，maxmemory-policy和缓存淘汰策略，避免内存不足导致的性能问题。



